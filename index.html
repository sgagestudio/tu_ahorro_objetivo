<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Objetivo de Ahorro ‚Äî 15.000‚Ç¨/a√±o</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.085);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.65);
      --line:rgba(255,255,255,.12);
      --good:#34d399;
      --bad:#fb7185;
      --shadow:0 18px 50px rgba(0,0,0,.45);
      --radius:18px;
      --radius2:14px;
      --mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      --sans:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      min-height:100vh;
      background:
        radial-gradient(1200px 600px at 15% 15%, rgba(167,139,250,.25), transparent 60%),
        radial-gradient(900px 500px at 80% 20%, rgba(110,231,255,.20), transparent 55%),
        radial-gradient(900px 600px at 45% 95%, rgba(52,211,153,.12), transparent 60%),
        var(--bg);
    }
    header{padding:28px 18px 8px;max-width:1100px;margin:0 auto;}
    .title{display:flex;align-items:flex-end;justify-content:space-between;gap:12px;flex-wrap:wrap;}
    h1{margin:0;font-size:clamp(22px,3vw,34px);letter-spacing:.2px;}
    .subtitle{margin:8px 0 0;color:var(--muted);line-height:1.35;}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:999px;
      background:linear-gradient(90deg, rgba(110,231,255,.18), rgba(167,139,250,.16));
      border:1px solid rgba(255,255,255,.12);
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      font-weight:600;color:rgba(255,255,255,.9);white-space:nowrap;
    }
    main{
      max-width:1100px;margin:0 auto;padding:14px 18px 48px;
      display:grid;grid-template-columns:1.15fr .85fr;gap:14px;
    }
    @media (max-width:980px){main{grid-template-columns:1fr;}}
    .card{
      background:linear-gradient(180deg,var(--card),rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.10);
      border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;
    }
    .card .hd{
      padding:16px 16px 12px;border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .card .hd h2{margin:0;font-size:16px;letter-spacing:.2px;}
    .card .bd{padding:16px;}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    @media (max-width:700px){.grid2{grid-template-columns:1fr;}}
    .kpi{
      background:linear-gradient(180deg,var(--card2),rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.10);
      border-radius:var(--radius2);padding:12px;
    }
    .kpi .label{color:var(--muted);font-size:12px;margin-bottom:6px;}
    .kpi .value{font-size:18px;font-weight:750;letter-spacing:.2px;}
    .progressWrap{margin-top:12px;}
    .progressTop{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:8px;color:var(--muted);font-size:12.5px;}
    .bar{
      height:14px;border-radius:999px;background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);overflow:hidden;
      box-shadow:inset 0 1px 0 rgba(255,255,255,.10);
    }
    .bar>div{
      height:100%;width:0%;border-radius:999px;
      background:linear-gradient(90deg, rgba(52,211,153,.95), rgba(110,231,255,.95), rgba(167,139,250,.95));
      box-shadow:0 10px 30px rgba(110,231,255,.12);
      transition:width .35s ease;
    }
    .hint{margin-top:10px;color:var(--muted);font-size:13px;line-height:1.35;}
    form{display:grid;gap:10px;}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    @media (max-width:700px){.row{grid-template-columns:1fr;}}
    label{display:grid;gap:6px;font-size:12px;color:var(--muted);}
    input,select,button,textarea{font:inherit;color:var(--text);}
    input,select,textarea{
      padding:11px 12px;border-radius:12px;background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.12);outline:none;
      transition:border-color .15s ease, transform .08s ease;
    }
    input:focus,select:focus,textarea:focus{border-color:rgba(110,231,255,.55);}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:4px;}
    button{
      border:0;cursor:pointer;padding:11px 12px;border-radius:12px;
      font-weight:750;letter-spacing:.2px;
      box-shadow:0 14px 35px rgba(0,0,0,.35);
      transition:transform .08s ease, filter .15s ease;
    }
    button:active{transform:translateY(1px);}
    .btnGood{background:linear-gradient(90deg, rgba(52,211,153,.95), rgba(110,231,255,.85));color:rgba(0,0,0,.75);}
    .btnBad{background:linear-gradient(90deg, rgba(251,113,133,.95), rgba(251,191,36,.72));color:rgba(0,0,0,.75);}
    .btnGhost{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);color:rgba(255,255,255,.9);box-shadow:none;}
    button:disabled{opacity:.55;cursor:not-allowed;transform:none;}
    table{
      width:100%;border-collapse:collapse;overflow:hidden;border-radius:14px;
      border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18);
    }
    th,td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.08);font-size:13px;vertical-align:top;}
    th{text-align:left;color:rgba(255,255,255,.78);font-size:12px;letter-spacing:.15px;background:rgba(255,255,255,.06);}
    .amt.pos{color:var(--good);font-weight:750;}
    .amt.neg{color:var(--bad);font-weight:750;}
    .mini{font-size:12px;color:var(--muted);margin-top:10px;line-height:1.35;}
    .dbBox{display:grid;gap:10px;}
    textarea{
      min-height:220px;resize:vertical;font-family:var(--mono);
      font-size:12.5px;line-height:1.35;
    }
    .toast{
      margin-top:10px;padding:10px 12px;border-radius:12px;background:rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.12);color:var(--muted);font-size:12.5px;display:none;
    }
    .badge{
      padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);font-size:12px;color:rgba(255,255,255,.8);
      display:inline-flex;gap:8px;align-items:center;
    }
    .statusRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;}
    .muted{color:var(--muted);}
    .ok{color:var(--good);}
    .danger{color:var(--bad);}
  </style>
</head>

<body>
  <header>
    <div class="title">
      <div>
        <h1>Objetivo de ahorro</h1>
        <p class="subtitle">Ingresos y gastos con c√°lculo en tiempo real + sincronizaci√≥n en Cloudflare (texto remoto).</p>
      </div>
      <div class="pill" id="yearPill">A√±o ‚Äî</div>
    </div>
  </header>

  <main>
    <!-- IZQUIERDA -->
    <section class="card">
      <div class="hd">
        <h2>Resumen</h2>
        <span class="muted" id="asOf">‚Äî</span>
      </div>

      <div class="bd">
        <div class="grid2">
          <div class="kpi">
            <div class="label">Objetivo anual</div>
            <div class="value" id="goalKpi">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="label">Ahorro neto (ingresos ‚àí gastos)</div>
            <div class="value" id="netKpi">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="label">Total ingresos</div>
            <div class="value" id="incomeKpi">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="label">Total gastos</div>
            <div class="value" id="expenseKpi">‚Äî</div>
          </div>
        </div>

        <div class="progressWrap">
          <div class="progressTop">
            <span id="progressText">Progreso ‚Äî</span>
            <span id="remainingText">Faltan ‚Äî</span>
          </div>
          <div class="bar"><div id="barFill"></div></div>
          <div class="hint" id="rateHint">‚Äî</div>
        </div>

        <hr style="border:0;border-top:1px solid var(--line);margin:16px 0;" />

        <div class="hd" style="padding:0 0 10px;border:none;">
          <h2>Nuevo movimiento</h2>
        </div>

        <form id="txForm">
          <div class="row">
            <label>
              Tipo
              <select id="type">
                <option value="income">Ingreso</option>
                <option value="expense">Gasto</option>
              </select>
            </label>
            <label>
              Fecha
              <input id="date" type="date" required />
            </label>
          </div>

          <div class="row">
            <label>
              Concepto
              <input id="desc" type="text" placeholder="Ej: N√≥mina, compra, alquiler..." maxlength="80" />
            </label>
            <label>
              Importe (‚Ç¨)
              <input id="amount" type="number" step="0.01" min="0" placeholder="0.00" required />
            </label>
          </div>

          <div class="actions">
            <button type="submit" class="btnGood">A√±adir</button>
            <button type="button" class="btnGhost" id="clearBtn">Limpiar todo</button>
          </div>

          <div class="toast" id="toast"></div>
        </form>

        <hr style="border:0;border-top:1px solid var(--line);margin:16px 0;" />

        <div class="hd" style="padding:0 0 10px;border:none;">
          <h2>Movimientos</h2>
          <span class="muted" id="countTx">‚Äî</span>
        </div>

        <div style="overflow:auto;">
          <table>
            <thead>
              <tr>
                <th style="min-width:110px;">Fecha</th>
                <th style="min-width:110px;">Tipo</th>
                <th>Concepto</th>
                <th style="min-width:120px;text-align:right;">Importe</th>
                <th style="min-width:90px;text-align:right;">Acci√≥n</th>
              </tr>
            </thead>
            <tbody id="txBody"></tbody>
          </table>
        </div>

        <div class="mini">
          Si usas varios dispositivos: abre la web, pulsa <b>Cargar nube</b> (para traer lo √∫ltimo) y luego ya a√±ade movimientos.
          Con <b>Auto-guardar</b> activado, cada cambio se guarda a la nube.
        </div>
      </div>
    </section>

    <!-- DERECHA -->
    <aside class="card">
      <div class="hd">
        <h2>Sincronizaci√≥n Cloudflare + hoja de texto</h2>
        <span class="muted">/data</span>
      </div>

      <div class="bd">
        <div class="dbBox">
          <div class="statusRow">
            <span class="badge" id="cloudStatus">Nube: <b>no configurada</b></span>
            <span class="badge" id="lastSync">√öltima sync: <b>‚Äî</b></span>
          </div>

          <div class="row">
            <label>
              API Base (tu Worker)
              <input id="apiBase" type="text" placeholder="https://TU-WORKER.workers.dev" />
            </label>
            <label>
              Token (X-Auth)
              <input id="authToken" type="password" placeholder="(tu secreto)" />
            </label>
          </div>

          <div class="row">
            <label style="grid-column:1/-1;">
              <span>Auto-guardar cambios en la nube</span>
              <select id="autosave">
                <option value="on">Activado</option>
                <option value="off">Desactivado</option>
              </select>
            </label>
          </div>

          <div class="actions">
            <button type="button" class="btnGood" id="loadCloudBtn">Cargar nube</button>
            <button type="button" class="btnGhost" id="saveCloudBtn">Guardar nube</button>
            <button type="button" class="btnBad" id="wipeRemoteBtn">Vaciar nube</button>
          </div>

          <div class="muted" style="font-size:13px;line-height:1.35;">
            Abajo est√° tu ‚Äúbase de datos‚Äù como texto dentro de la web (JSON). Puedes editarla y pulsar ‚ÄúImportar‚Äù.
            <br>Formato: <span style="font-family:var(--mono);">[{"id","type","date","desc","amount"}, ...]</span>
          </div>

          <textarea id="dbText" spellcheck="false"></textarea>

          <div class="actions">
            <button type="button" class="btnGhost" id="refreshTextBtn">Refrescar texto</button>
            <button type="button" class="btnGood" id="importTextBtn">Importar desde texto</button>
            <button type="button" class="btnBad" id="resetDemoBtn">Reset demo</button>
          </div>

          <div class="mini">
            Nota: esto NO intenta escribir un archivo est√°tico en Cloudflare Pages (eso no se puede).
            Guarda un ‚Äútexto‚Äù remoto mediante tu Worker (KV/R2) en la ruta <b>/data</b>.
          </div>
        </div>
      </div>
    </aside>
  </main>

  <script>
    // =============================
    // CONFIG
    // =============================
    const GOAL_YEAR = 15000;

    // =============================
    // STATE
    // =============================
    /** @type {{id:string,type:"income"|"expense",date:string,desc:string,amount:number}[]} */
    let db = [];
    let lastRemoteHash = null;     // para detectar cambios remotos y evitar pisadas
    let lastSyncAt = null;

    const SETTINGS_KEY = "ahorro_cloud_settings_v1";

    // =============================
    // HELPERS
    // =============================
    const ‚Ç¨ = (n) => Number(n || 0).toLocaleString("es-ES", { style:"currency", currency:"EUR" });
    const clamp = (v,a,b) => Math.max(a, Math.min(b, v));
    const uid = () => Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);

    const todayISO = () => {
      const d = new Date();
      const pad = (x) => String(x).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    };

    const endOfYear = (year) => new Date(year, 11, 31, 23, 59, 59);

    const daysBetween = (a, b) => {
      const ms = b.getTime() - a.getTime();
      return Math.max(0, Math.ceil(ms / (1000*60*60*24)));
    };

    function djb2Hash(str){
      let h = 5381;
      for (let i=0;i<str.length;i++){
        h = ((h << 5) + h) + str.charCodeAt(i);
        h = h | 0;
      }
      return String(h);
    }

    function toast(msg, kind="info"){
      const el = document.getElementById("toast");
      el.style.display = "block";
      el.textContent = msg;
      el.style.borderColor =
        kind === "ok" ? "rgba(52,211,153,.35)" :
        kind === "bad" ? "rgba(251,113,133,.40)" :
        "rgba(255,255,255,.14)";
      clearTimeout(toast._t);
      toast._t = setTimeout(()=>{ el.style.display="none"; }, 2600);
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function sanitize(arr){
      const out = [];
      for (const x of arr){
        if(!x || typeof x !== "object") continue;
        const type = (x.type === "expense") ? "expense" : "income";
        const date = (typeof x.date === "string" && /^\d{4}-\d{2}-\d{2}$/.test(x.date)) ? x.date : todayISO();
        const desc = (typeof x.desc === "string") ? x.desc.slice(0,80) : "";
        const amount = Number(x.amount);
        if(!Number.isFinite(amount) || amount < 0) continue;
        out.push({
          id: (x.id && typeof x.id === "string") ? x.id : uid(),
          type, date, desc,
          amount: Math.round(amount * 100) / 100
        });
      }
      return out;
    }

    // =============================
    // CALCULATIONS
    // =============================
    function totals(){
      let income = 0, expense = 0;
      for(const t of db){
        if(t.type === "income") income += t.amount;
        else expense += t.amount;
      }
      income = Math.round(income*100)/100;
      expense = Math.round(expense*100)/100;
      const net = Math.round((income-expense)*100)/100;
      return { income, expense, net };
    }

    function requiredRates(net){
      const now = new Date();
      const year = now.getFullYear();
      const eoy = endOfYear(year);

      const remaining = Math.max(0, GOAL_YEAR - net);
      const remainingDays = Math.max(1, daysBetween(now, eoy));

      const perDay = remaining / remainingDays;
      const perWeek = perDay * 7;
      const avgMonthDays = 365.2425 / 12; // ~30.44
      const perMonth = remaining / (remainingDays / avgMonthDays);

      return { year, remaining, remainingDays, perDay, perWeek, perMonth };
    }

    // =============================
    // TEXT DB
    // =============================
    function refreshDbText(showToast=true){
      document.getElementById("dbText").value = JSON.stringify(db, null, 2);
      if(showToast) toast("Texto actualizado.", "ok");
    }

    function importFromText(){
      const ta = document.getElementById("dbText");
      try{
        const parsed = JSON.parse(ta.value);
        if(!Array.isArray(parsed)) throw new Error("El JSON debe ser un array.");
        db = sanitize(parsed);
        render();
        toast("Importaci√≥n correcta ‚úÖ", "ok");
        maybeAutoSaveCloud();
      }catch(e){
        toast(`No se pudo importar: ${e.message}`, "bad");
      }
    }

    // =============================
    // CLOUD SETTINGS
    // =============================
    function getSettings(){
      const apiBase = (document.getElementById("apiBase").value || "").trim().replace(/\/+$/,"");
      const token = (document.getElementById("authToken").value || "").trim();
      const autosave = document.getElementById("autosave").value === "on";
      return { apiBase, token, autosave };
    }

    function saveSettingsToLocal(){
      const { apiBase, autosave } = getSettings();
      // Por seguridad NO guardo el token autom√°ticamente. Si quieres guardarlo, c√°mbialo aqu√≠.
      localStorage.setItem(SETTINGS_KEY, JSON.stringify({ apiBase, autosave }));
    }

    function loadSettingsFromLocal(){
      try{
        const raw = localStorage.getItem(SETTINGS_KEY);
        if(!raw) return;
        const s = JSON.parse(raw);
        if(s.apiBase) document.getElementById("apiBase").value = s.apiBase;
        if(typeof s.autosave === "boolean") document.getElementById("autosave").value = s.autosave ? "on" : "off";
      }catch{}
    }

    function updateCloudStatus(){
      const { apiBase, token } = getSettings();
      const ok = !!apiBase;
      document.getElementById("cloudStatus").innerHTML = ok
        ? `Nube: <b>configurada</b>${token ? `` : ` <span class="danger">(sin token)</span>`}`
        : `Nube: <b>no configurada</b>`;
      document.getElementById("lastSync").innerHTML = `√öltima sync: <b>${lastSyncAt ? lastSyncAt : "‚Äî"}</b>`;

      const saveBtn = document.getElementById("saveCloudBtn");
      const loadBtn = document.getElementById("loadCloudBtn");
      const wipeBtn = document.getElementById("wipeRemoteBtn");
      loadBtn.disabled = !apiBase;
      saveBtn.disabled = !apiBase || !token;
      wipeBtn.disabled = !apiBase || !token;
    }

    // =============================
    // CLOUD API
    // =============================
    async function cloudGetText(){
      const { apiBase } = getSettings();
      const res = await fetch(`${apiBase}/data`, { method:"GET" });
      if(!res.ok) throw new Error(`No se pudo leer /data (${res.status})`);
      return await res.text();
    }

    async function cloudPutText(text){
      const { apiBase, token } = getSettings();
      const res = await fetch(`${apiBase}/data`, {
        method:"PUT",
        headers:{
          "Content-Type":"text/plain; charset=utf-8",
          "X-Auth": token
        },
        body:text
      });
      if(!res.ok){
        const msg = await res.text().catch(()=> "");
        throw new Error(`No se pudo guardar (${res.status}) ${msg}`.trim());
      }
    }

    async function loadFromCloud(){
      saveSettingsToLocal();
      updateCloudStatus();

      const text = await cloudGetText();
      let parsed;
      try{
        parsed = JSON.parse(text);
      }catch{
        throw new Error("El remoto no es JSON v√°lido.");
      }
      if(!Array.isArray(parsed)) throw new Error("El remoto debe ser un array JSON.");

      db = sanitize(parsed);
      lastRemoteHash = djb2Hash(JSON.stringify(db)); // hash normalizado
      lastSyncAt = new Date().toLocaleString("es-ES");
      render();
      toast("Cargado desde la nube ‚úÖ", "ok");
    }

    async function saveToCloud({ force=false } = {}){
      saveSettingsToLocal();
      updateCloudStatus();

      // protecci√≥n simple contra pisadas:
      // 1) si ya cargaste una versi√≥n antes (lastRemoteHash), comprobaremos si el remoto cambi√≥
      if(lastRemoteHash && !force){
        const remoteText = await cloudGetText();
        let remoteParsed;
        try { remoteParsed = JSON.parse(remoteText); } catch { remoteParsed = null; }
        if(Array.isArray(remoteParsed)){
          const remoteNormHash = djb2Hash(JSON.stringify(sanitize(remoteParsed)));
          if(remoteNormHash !== lastRemoteHash){
            const ok = confirm(
              "Parece que la nube cambi√≥ desde la √∫ltima vez que cargaste.\n\n" +
              "Si guardas ahora, podr√≠as pisar cambios hechos en otro dispositivo.\n\n" +
              "¬øQuieres SOBRESCRIBIR igualmente?"
            );
            if(!ok) return;
          }
        }
      }

      const text = JSON.stringify(db, null, 2);
      // worker valida que sea array JSON
      await cloudPutText(text);

      lastRemoteHash = djb2Hash(JSON.stringify(db));
      lastSyncAt = new Date().toLocaleString("es-ES");
      updateCloudStatus();
      toast("Guardado en la nube ‚úÖ", "ok");
    }

    async function wipeCloud(){
      const ok = confirm("¬øSeguro que quieres vaciar la nube? Esto guardar√° [] en /data.");
      if(!ok) return;
      db = [];
      render();
      await saveToCloud({ force:true });
    }

    async function maybeAutoSaveCloud(){
      const { apiBase, token, autosave } = getSettings();
      if(!apiBase || !token || !autosave) return;
      // No bloqueamos UX si falla
      saveToCloud().catch(e => toast(e.message, "bad"));
    }

    // =============================
    // RENDER
    // =============================
    function render(){
      const { income, expense, net } = totals();
      const r = requiredRates(net);

      document.getElementById("yearPill").textContent = `A√±o ${r.year} ‚Äî objetivo ${‚Ç¨(GOAL_YEAR)}`;
      document.getElementById("asOf").textContent = `Actualizado: ${new Date().toLocaleString("es-ES")}`;

      document.getElementById("goalKpi").textContent = ‚Ç¨(GOAL_YEAR);
      document.getElementById("netKpi").textContent = ‚Ç¨(net);
      document.getElementById("incomeKpi").textContent = ‚Ç¨(income);
      document.getElementById("expenseKpi").textContent = ‚Ç¨(expense);

      const pct = clamp((net / GOAL_YEAR) * 100, 0, 100);
      document.getElementById("barFill").style.width = `${pct}%`;
      document.getElementById("progressText").textContent = `Progreso: ${pct.toFixed(1)}%`;

      const remainingText = (GOAL_YEAR - net);
      document.getElementById("remainingText").textContent =
        remainingText <= 0 ? "Objetivo alcanzado üéâ" : `Faltan ${‚Ç¨(remainingText)}`;

      const hintEl = document.getElementById("rateHint");
      if(remainingText <= 0){
        hintEl.innerHTML = `<span class="ok"><b>¬°Ya has alcanzado el objetivo anual!</b></span>`;
      }else{
        hintEl.innerHTML =
          `Te faltan <b>${‚Ç¨(r.remaining)}</b> en <b>${r.remainingDays}</b> d√≠as. ` +
          `Media necesaria: <b>${‚Ç¨(r.perDay)}</b>/d√≠a ¬∑ <b>${‚Ç¨(r.perWeek)}</b>/semana ¬∑ <b>${‚Ç¨(r.perMonth)}</b>/mes.`;
      }

      // Tabla
      const body = document.getElementById("txBody");
      body.innerHTML = "";

      const sorted = [...db].sort((a,b)=> (a.date < b.date ? 1 : a.date > b.date ? -1 : 0));
      for(const t of sorted){
        const tr = document.createElement("tr");
        const typeLabel = t.type === "income" ? "Ingreso" : "Gasto";
        const amtClass = t.type === "income" ? "pos" : "neg";
        const sign = t.type === "income" ? "+" : "‚àí";
        tr.innerHTML = `
          <td>${t.date}</td>
          <td>${typeLabel}</td>
          <td>${escapeHtml(t.desc || "")}</td>
          <td style="text-align:right;"><span class="amt ${amtClass}">${sign} ${‚Ç¨(t.amount)}</span></td>
          <td style="text-align:right;">
            <button class="btnGhost" data-del="${t.id}" style="padding:8px 10px;border-radius:10px;">Borrar</button>
          </td>
        `;
        body.appendChild(tr);
      }

      document.getElementById("countTx").textContent = `${db.length} mov.`;

      body.querySelectorAll("button[data-del]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-del");
          db = db.filter(x => x.id !== id);
          render();
          maybeAutoSaveCloud();
        });
      });

      refreshDbText(false);
      updateCloudStatus();
    }

    // =============================
    // INIT
    // =============================
    document.getElementById("date").value = todayISO();

    // Demo inicial (local) por si todav√≠a no usas nube
    db = [
      { id: uid(), type:"income", date: todayISO(), desc:"Ingreso demo", amount: 1200 },
      { id: uid(), type:"expense", date: todayISO(), desc:"Alquiler demo", amount: 550 },
      { id: uid(), type:"expense", date: todayISO(), desc:"Compra demo", amount: 85.40 }
    ];

    // Eventos UI
    document.getElementById("txForm").addEventListener("submit", (ev)=>{
      ev.preventDefault();

      const type = document.getElementById("type").value;
      const date = document.getElementById("date").value || todayISO();
      const desc = (document.getElementById("desc").value || "").trim();
      const amount = Number(document.getElementById("amount").value);

      if(!Number.isFinite(amount) || amount <= 0){
        toast("Introduce un importe v√°lido (> 0).", "bad");
        return;
      }

      db.push({
        id: uid(),
        type: (type === "expense") ? "expense" : "income",
        date,
        desc,
        amount: Math.round(amount * 100) / 100
      });

      document.getElementById("amount").value = "";
      document.getElementById("desc").value = "";

      render();
      toast("Movimiento a√±adido.", "ok");
      maybeAutoSaveCloud();
    });

    document.getElementById("clearBtn").addEventListener("click", ()=>{
      if(!confirm("¬øSeguro que quieres borrar TODOS los movimientos?")) return;
      db = [];
      render();
      toast("Datos borrados.", "ok");
      maybeAutoSaveCloud();
    });

    document.getElementById("refreshTextBtn").addEventListener("click", ()=> refreshDbText(true));
    document.getElementById("importTextBtn").addEventListener("click", ()=> importFromText());
    document.getElementById("resetDemoBtn").addEventListener("click", ()=>{
      db = [
        { id: uid(), type:"income", date: todayISO(), desc:"Ingreso demo", amount: 1800 },
        { id: uid(), type:"expense", date: todayISO(), desc:"Alquiler demo", amount: 700 },
        { id: uid(), type:"expense", date: todayISO(), desc:"Gasolina demo", amount: 60.25 }
      ];
      lastRemoteHash = null;
      lastSyncAt = null;
      render();
      toast("Demo cargada.", "ok");
    });

    document.getElementById("loadCloudBtn").addEventListener("click", ()=>{
      loadFromCloud().catch(e => toast(e.message, "bad"));
    });

    document.getElementById("saveCloudBtn").addEventListener("click", ()=>{
      saveToCloud().catch(e => toast(e.message, "bad"));
    });

    document.getElementById("wipeRemoteBtn").addEventListener("click", ()=>{
      wipeCloud().catch(e => toast(e.message, "bad"));
    });

    document.getElementById("apiBase").addEventListener("input", ()=>{
      saveSettingsToLocal();
      updateCloudStatus();
    });
    document.getElementById("autosave").addEventListener("change", ()=>{
      saveSettingsToLocal();
      updateCloudStatus();
    });
    document.getElementById("authToken").addEventListener("input", ()=>{
      updateCloudStatus();
    });

    // Carga ajustes (API base + autosave)
    loadSettingsFromLocal();

    // Render inicial
    render();
  </script>
</body>
</html>
